name: ci-enforcement

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  action-1-pylint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve project directory
        id: project_dir
        run: |
          if [ -f "requirements.txt" ] && [ -d "src" ]; then
            echo "dir=." >> "$GITHUB_OUTPUT"
          elif [ -f "Module_5/requirements.txt" ] && [ -d "Module_5/src" ]; then
            echo "dir=Module_5" >> "$GITHUB_OUTPUT"
          else
            echo "Module_5 project directory not found."
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: |
            ${{ steps.project_dir.outputs.dir }}/requirements.txt

      - name: Install dependencies
        working-directory: ${{ steps.project_dir.outputs.dir }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pylint

      - name: Run Pylint (fail-under 10)
        working-directory: ${{ steps.project_dir.outputs.dir }}
        run: |
          pylint src --fail-under=10

  action-2-dependency-graph:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve project directory
        id: project_dir
        run: |
          if [ -f "requirements.txt" ] && [ -d "src" ]; then
            echo "dir=." >> "$GITHUB_OUTPUT"
          elif [ -f "Module_5/requirements.txt" ] && [ -d "Module_5/src" ]; then
            echo "dir=Module_5" >> "$GITHUB_OUTPUT"
          else
            echo "Module_5 project directory not found."
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: |
            ${{ steps.project_dir.outputs.dir }}/requirements.txt

      - name: Install dependencies
        working-directory: ${{ steps.project_dir.outputs.dir }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pydeps

      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      - name: Generate dependency.svg
        working-directory: ${{ steps.project_dir.outputs.dir }}
        run: |
          pydeps src/website.py --noshow -T svg -o dependency.svg

      - name: Verify dependency.svg
        working-directory: ${{ steps.project_dir.outputs.dir }}
        run: |
          command -v dot
          test -s dependency.svg

      - name: Upload dependency graph artifact
        uses: actions/upload-artifact@v4
        with:
          name: dependency-svg
          path: ${{ steps.project_dir.outputs.dir }}/dependency.svg

  action-3-snyk-test:
    runs-on: ubuntu-latest
    env:
      SNYK_FAIL_ON_ISSUES: ${{ vars.SNYK_FAIL_ON_ISSUES }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve project directory
        id: project_dir
        run: |
          if [ -f "requirements.txt" ] && [ -d "src" ]; then
            echo "dir=." >> "$GITHUB_OUTPUT"
          elif [ -f "Module_5/requirements.txt" ] && [ -d "Module_5/src" ]; then
            echo "dir=Module_5" >> "$GITHUB_OUTPUT"
          else
            echo "Module_5 project directory not found."
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: |
            ${{ steps.project_dir.outputs.dir }}/requirements.txt

      - name: Install dependencies
        working-directory: ${{ steps.project_dir.outputs.dir }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Setup Snyk CLI
        if: ${{ secrets.SNYK_TOKEN != '' }}
        uses: snyk/actions/setup@master

      - name: Run Snyk test (collect output)
        id: snyk_scan
        if: ${{ secrets.SNYK_TOKEN != '' }}
        working-directory: ${{ steps.project_dir.outputs.dir }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set +e
          snyk test --file=requirements.txt --json-file-output=snyk-test.json > snyk-test.txt 2>&1
          exit_code=$?
          cat snyk-test.txt
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Snyk skipped (no token configured)
        if: ${{ secrets.SNYK_TOKEN == '' }}
        working-directory: ${{ steps.project_dir.outputs.dir }}
        run: |
          echo "SNYK_TOKEN is not set; skipping snyk test." | tee snyk-test.txt
          echo '{"skipped":"missing SNYK_TOKEN"}' > snyk-test.json

      - name: Upload Snyk output artifact
        uses: actions/upload-artifact@v4
        with:
          name: snyk-test-output
          path: |
            ${{ steps.project_dir.outputs.dir }}/snyk-test.txt
            ${{ steps.project_dir.outputs.dir }}/snyk-test.json

      - name: Enforce Snyk gate (optional)
        if: ${{ secrets.SNYK_TOKEN != '' }}
        run: |
          scan_code="${{ steps.snyk_scan.outputs.exit_code }}"
          fail_on_issues="${SNYK_FAIL_ON_ISSUES:-false}"
          echo "Snyk exit code: ${scan_code}"

          if [ "${scan_code}" -ge 2 ]; then
            echo "Snyk execution error."
            exit "${scan_code}"
          fi

          if [ "${scan_code}" -eq 1 ] && [ "${fail_on_issues}" = "true" ]; then
            echo "Snyk reported vulnerabilities and SNYK_FAIL_ON_ISSUES=true."
            exit 1
          fi

          echo "Snyk output captured. Vulnerabilities are non-blocking unless SNYK_FAIL_ON_ISSUES=true."

  action-4-pytest:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: zhang8
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: grad_cafe
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U zhang8 -d grad_cafe"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Resolve project directory
        id: project_dir
        run: |
          if [ -f "requirements.txt" ] && [ -d "src" ]; then
            echo "dir=." >> "$GITHUB_OUTPUT"
          elif [ -f "Module_5/requirements.txt" ] && [ -d "Module_5/src" ]; then
            echo "dir=Module_5" >> "$GITHUB_OUTPUT"
          else
            echo "Module_5 project directory not found."
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: |
            ${{ steps.project_dir.outputs.dir }}/requirements.txt

      - name: Install dependencies
        working-directory: ${{ steps.project_dir.outputs.dir }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Run pytest
        working-directory: ${{ steps.project_dir.outputs.dir }}
        env:
          DATABASE_URL: postgresql://zhang8:postgres@localhost:5432/grad_cafe
        run: |
          pytest -m "web or buttons or analysis or db or integration"
